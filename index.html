<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>ADHD Reader</title>

<link rel="stylesheet" href="styles.css">


</head>
<body>

<div id="controls">
    <textarea id="textInput" placeholder="Paste your text here..."></textarea>
    <button id="playBtn">▶ Play</button>
    <button id="speedBtn">⚡</button>
    <div id="sliderContainer">
        <span id="wpmLabel">250 WPM</span>
        <input type="range" id="wpmSlider" min="100" max="600" step="25" value="250">
    </div>
</div>

<div id="reader">
    <div id="wordDisplay" class="word"></div>
</div>

<script>
let units = [];
let index = 0;
let timer = null;
let wpm = 300;
let playing = false;

const textInput = document.getElementById("textInput");
const playBtn = document.getElementById("playBtn");
const speedBtn = document.getElementById("speedBtn");
const sliderContainer = document.getElementById("sliderContainer");
const wpmSlider = document.getElementById("wpmSlider");
const wpmLabel = document.getElementById("wpmLabel");
const reader = document.getElementById("reader");
const wordDisplay = document.getElementById("wordDisplay");
const controls = document.getElementById("controls");

/* ---------- ORP ---------- */
function getORPIndex(word) {
    const len = word.length;
    if (len <= 2) return 0;
    if (len <= 5) return 1;
    return 2;
}

/* ---------- PREPROCESS ---------- */
function preprocessText(text) {
    // YAML frontmatter
    text = text.replace(/^---\s*\n[\s\S]*?\n---\s*\n?/, "");

    // horizontal rules
    text = text.replace(/^\s*---\s*$/gm, "");

    // Obsidian embeds
    text = text.replace(/!\[\[.*?\]\]/g, "(image)");

    // Markdown images
    text = text.replace(/!\[[^\]]*\]\([^)]+\)/g, "(image)");

    // Tables
    text = text.replace(/(?:^\s*\|.*\|\s*\n)+/gm, "(table)\n");

    return text;
}

/* ---------- PARSE ---------- */
function parseContent(text) {
    text = preprocessText(text);
    const lines = text.split("\n");
    const result = [];

    for (let line of lines) {
        let trimmed = line.trim();
        if (!trimmed) continue;

        const startIndex = result.length;

        trimmed
            .replace(/\*\*\*|\*\*|\*|==|_/g, "")
            .split(/\s+/)
            .forEach(word => {
                if (word) result.push({ content: word });
            });

        const lastChar = trimmed.slice(-1);
        if (!/[,:.\-–+?]$/.test(lastChar)) {
            for (let i = result.length - 1; i >= startIndex; i--) {
                if (result[i]) {
                    result[i].endDot = true;
                    break;
                }
            }
        }
    }

    return result;
}

/* ---------- RENDER ---------- */
function renderWord(unit) {
    let word = unit.content;
    let hasDot = false;

    if (word.endsWith(".")) {
        hasDot = true;
        word = word.slice(0, -1);
        unit.endDot = true;
    }

    const i = getORPIndex(word);

    const dot = unit.endDot || hasDot
        ? `<span style="color: cyan;">.</span>`
        : "";

    wordDisplay.innerHTML =
        `<span>${word.slice(0, i)}</span>` +
        `<span class="orp">${word[i] || ""}</span>` +
        `<span>${word.slice(i + 1)}</span>` +
        dot;
}

/* ---------- TIMING ---------- */
function getWordDelay(word, unit) {
    let effective = wpm;
    if (word.length > 6) effective *= 0.8;

    let delay = 60000 / effective;

    if (unit?.endDot) delay += 800;

    return delay;
}

function playNextWord() {
    if (!playing) return;

    if (index >= units.length) {
        stopReading();
        return;
    }

    const unit = units[index++];
    renderWord(unit);

    const delay = getWordDelay(unit.content, unit);
    timer = setTimeout(playNextWord, delay);
}

/* ---------- READER CONTROL ---------- */
function startReading() {
    let text = textInput.value.trim();
    if (!text) return;

    units = parseContent(text);
    index = 0;
    playing = true;

    reader.style.display = "flex";
    controls.style.display = "none";
    reader.classList.remove("paused");

    playNextWord();
}

function stopReading() {
    clearTimeout(timer);
    timer = null;
    playing = false;

    reader.style.display = "none";
    controls.style.display = "flex";
    reader.classList.remove("paused");
}

/* ---------- UI ---------- */
playBtn.onclick = startReading;

speedBtn.onclick = () => {
    sliderContainer.style.display =
        sliderContainer.style.display === "flex" ? "none" : "flex";
};

wpmSlider.oninput = () => {
    wpm = Number(wpmSlider.value);
    wpmLabel.textContent = `${wpm} WPM`;
};

wpmLabel.textContent = `${wpm} WPM`;

/* ---------- AUTO-GROW ---------- */
textInput.addEventListener("input", () => {
    textInput.style.height = "auto";
    textInput.style.height = textInput.scrollHeight + "px";
});

/* ---------- KEYBOARD ---------- */
document.addEventListener("keydown", (e) => {
    const readerActive = reader.style.display === "flex";

    if (e.code === "Escape" && readerActive) {
        e.preventDefault();
        stopReading();
        return;
    }

    if (e.code === "Space" && readerActive) {
        e.preventDefault();
        if (playing) {
            clearTimeout(timer);
            playing = false;
            reader.classList.add("paused");
        } else {
            playing = true;
            reader.classList.remove("paused");
            playNextWord();
        }
    }
});
</script>


</body>
</html>
